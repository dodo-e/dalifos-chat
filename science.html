<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="q_vJ_negIqtaZpzVtg0aMM9CNBFzAuNxlm2kTpHXAtA">
    <meta name="keywords" content="chatting online, online chat, Dalifos, Ai chat, public chat, voice notes, free chat, dalifos chat, dalifos online chat, dalifos ai chat, dalifos public chat, dalifos voice notes, chat">
    <meta name="description" content="Dalifos ¬© Chat is a free online public chat where you can chat with others, send voice notes, and more. Join the Dalifos community today! No sign in required!">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="author" content="Dalifos">
    <meta name="rating" content="+10">
    <title>Dalifos ¬© Chat science group</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&amp;display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="assets/logo.png" type="image/x-icon">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- GTranslate -->
    <script>
        window.gtranslateSettings = {
            "default_language": "en",
            "native_language_names": true,
            "detect_browser_language": true,
            "wrapper_selector": ".gtranslate_wrapper",
            "switcher_horizontal_position": "left",
            "switcher_vertical_position": "top"
        };
    </script>
    <script src="https://cdn.gtranslate.net/widgets/latest/float.js" defer></script>

    <style>
        .typing-indicator {
            color: #999;
            font-style: italic;
            padding: 5px 10px;
            font-size: 12px;
        }

        .mention {
            color: #aa1a01;
            font-style: italic;
            font-weight: bold;
            cursor: pointer;
        }

        .mention:hover {
            text-decoration: underline;
        }

        .edited-label {
            font-size: 10px;
            color: #999;
            font-style: italic;
            margin-left: 5px;
        }

        .seen-by {
            font-size: 11px;
            color: #0159aa;
            margin-top: 3px;
            font-style: italic;
        }

        .seen-icon {
            display: inline-block;
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <div class="gtranslate_wrapper"></div>

    <div class="dot-spinner">
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
    </div>

    <div class="dropdown">
        <div class="dropbtn-container">
            <button class="dropbtn">‚ò∞</button>
        </div>
        <div class="dropdown-content">
            <p>pages</p>
            <a href="whats%20new%20in%20Dalifos%20chat.html" title="what's new in Dalifos chat"><img src="assets/logo.png">what's new</a>
            <a href="https://forms.gle/HfwsYZVLD84mia2b8" title="report errors"><img src="assets/error-svgrepo-com.svg">report errors</a>
            <a href="channel.html" title="youtube channel"><img src="assets/YouTube-logo.png">youtube channel</a>
            <a href="https://dalifosstatus.statuspage.io/" title="status page"><img src="assets/logo%20main.png">status page</a>

            <p>settings</p>
            <button id="themeToggle">Dark Mode</button>
            <button id="notificationToggle"> Notifications On</button>
            <button id="emojiPickerBtn">üòÄ Emoji Picker</button>

            <p>chats</p>
            <a href="#" title="private chat" style="cursor: not-allowed;"><img src="assets/private-message-svgrepo-com.svg"> &gt;private chat (Coming Soon)</a>
            <a href="#" title="private group (not created)" style="cursor: not-allowed;"><img src="assets/group-chat-svgrepo-com.svg">private group chat (comming soon)</a>
            <a href="index.html" title="public chat"><img src="assets/public-opened-svgrepo-com.svg">public chat </a>
            <p>other progects</p>
            <a href="https://dodo-e.github.io/dalifos-website/" title="Dalifos main web"><img src="assets/logo%20main.png">Dalifos¬© web</a>
            <a href="index.html" title="Dalifos¬© chat"><img src="assets/public-opened-svgrepo-com.svg">Dalifos¬© chat</a>
            <a href="https://dodo-e.github.io/Dalifos-BD1/" title="Dalifos¬© BD1"><img src="assets/logo%20(2).png">Dalifos¬© BD1</a>
        </div>
    </div>

    <h2>üí¨ Dalifos Chat science group üí¨</h2>

    <!-- Online Users Section -->
    <div id="onlineUsersContainer" style="display: none;">
        <p style="color: #0159aa; margin: 5px 0; font-size: 20px;">üë• Active Users: <span id="onlineCount">0</span></p>
        <div id="usersList" style="background: #f0f0f0; border-radius: 10px; padding: 10px; margin-bottom: 10px; max-height: fit-content; overflow-y: auto; color: #333; font-size: 12px; width: fit-content; margin: auto; display: block;"></div>
    </div>

    <!-- Typing Indicator -->
    <div id="typingIndicator" class="typing-indicator" style="display: none;"></div>

    <div id="chat" role="main"></div>
    <br>
    
    <div class="chatting">
        <input type="file" id="avatar" accept="image/*" style="display: none;">
        <button type="button" id="avatarBtn" title="Choose an avatar (optional)">
            <img src="assets/avatar-default-svgrepo-com.svg" alt="choose avatar" class="avatar-icon">
        </button>
        <input type="text" id="name" placeholder="name" title="Enter your name">
        <input type="text" id="messages" placeholder="Type here" title="Type your message here (Press Enter to send)">
        <button id="sendBtn"><img src="assets/paper-plane-tilt-fill-svgrepo-com.svg" title="Send"></button>
        <br>
        <button id="recordBtn"><img src="assets/microphone-sensitivity-high-svgrepo-com.svg" title="start voice note"></button>
        <button id="stopBtn"><img src="assets/microphone-disabled-svgrepo-com.svg" title="stop voice note"></button>
        <button id="soundButton"><img src="assets/emoji-flags-svgrepo-com.svg" title="make like a wake for chat"></button>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emojiModal" style="display: none; position: fixed; bottom: 250px; right: 20px; background: white; border: 2px solid #0159aa; border-radius: 10px; padding: 10px; z-index: 1000; max-width: 300px; max-height: 300px; overflow-y: auto;">
        <div id="emojiGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px;"></div>
    </div>

    <!-- Edit Message Modal -->
    <div id="editModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 2px solid #0159aa; border-radius: 10px; padding: 20px; z-index: 2000; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h3 style="margin: 0 0 15px 0; color: #333;">Edit</h3>
        <input type="text" id="editMessageInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; box-sizing: border-box;">
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="editSaveBtn" style="padding: 8px 16px; background: #0159aa; color: white; border: none; border-radius: 5px; cursor: pointer;">Save</button>
            <button id="editCancelBtn" style="padding: 8px 16px; background: #ccc; color: black; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <!-- Edit Modal Overlay -->
    <div id="editOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;"></div>

    <script src="https://dalifosstatus1.statuspage.io/embed/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <script>
// ============ VARIABLE DECLARATIONS ============
let notificationsEnabled = localStorage.getItem("notifications_enabled") !== "false";
let darkMode = localStorage.getItem("dark_mode") === "true";
let typingTimeout = null;
let currentEditingMsgId = null;
let allMessages = [];
let userProfiles = {};
let seenMessages = new Map();
let mediaRecorder = null;
let audioChunks = [];
let bellSound = null;
let currentUser = "Anonymous";

        const supabaseUrl = 'https://auojqvmbgbpfkoatkvkl.supabase.co';
        const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1b2pxdm1iZ2JwZmtvYXRrdmtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzkzMzIsImV4cCI6MjA3MTAxNTMzMn0.FkqEo9BWHkBixdoQ2vEJdpZ-34l77L0Inbh62AIRFG4';
        const client = window.supabase.createClient(supabaseUrl, anonKey);

        const savedName = localStorage.getItem("chat_name");
        const savedAvatar = localStorage.getItem("chat_avatar");

        if (savedName) {
            document.getElementById("name").value = savedName;
        }

        // Utility: Format relative time
        function formatRelativeTime(timestamp) {
            const now = new Date();
            const msgTime = new Date(timestamp);
            const diffMs = now - msgTime;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffSecs < 60) return "just now";
            if (diffMins < 60) return `${diffMins} m ago`;
            if (diffHours < 24) return `${diffHours} h ago`;
            if (diffDays < 7) return `${diffDays} d ago`;
            return msgTime.toLocaleDateString();
        }

        // Utility: Highlight mentions in text
        function highlightMentions(text) {
            return text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        // Typing indicator
        const messagesInput = document.getElementById("messages");
        const typingIndicator = document.getElementById("typingIndicator");

        messagesInput.addEventListener("input", () => {
            const name = document.getElementById("name").value.trim() || "Anonymous";
            clearTimeout(typingTimeout);

            client.channel('typing-indicator').send({
                type: 'broadcast',
                event: 'user-typing',
                payload: { name: name }
            }).catch(() => {});

            typingTimeout = setTimeout(() => {
                client.channel('typing-indicator').send({
                    type: 'broadcast',
                    event: 'user-stopped-typing',
                    payload: { name: name }
                }).catch(() => {});
            }, 1000);
        });

        client.channel('typing-indicator')
            .on('broadcast', { event: 'user-typing' }, (payload) => {
                const name = document.getElementById("name").value.trim() || "Anonymous";
                if (payload.payload.name !== name) {
                    typingIndicator.textContent = `‚úèÔ∏è ${payload.payload.name} is typing...`;
                    typingIndicator.style.display = "block";
                }
            })
            .on('broadcast', { event: 'user-stopped-typing' }, (payload) => {
                typingIndicator.style.display = "none";
            })
            .subscribe();

        // Theme Toggle
        const themeToggle = document.getElementById("themeToggle");
        themeToggle.addEventListener("click", () => {
            darkMode = !darkMode;
            localStorage.setItem("dark_mode", darkMode);
            applyTheme();
        });

        function applyTheme() {
            if (darkMode) {
                document.body.style.backgroundColor = "black";
                document.body.style.color = "#e0e0e0";

                const allText = document.querySelectorAll("p, h1, h2, h3, h4, span");
                allText.forEach(el => {
                    if (!el.style.color || el.style.color === "black") {
                        el.style.color = "#e0e0e0";
                    }
                });

                const inputs = document.querySelectorAll("input[type='text']");
                inputs.forEach(input => {
                    input.style.backgroundColor = "#333";
                    input.style.color = "#e0e0e0";
                    input.style.borderColor = "#555";
                });

                const buttons = document.querySelectorAll("button");
                buttons.forEach(btn => {
                    if (btn.style.background === "" || btn.style.backgroundColor === "white" || btn.style.backgroundColor === "rgb(255, 255, 255)") {
                        btn.style.backgroundColor = "off-white";
                        btn.style.color = "#e0e0e0";
                    }
                });

                const dropdownContent = document.querySelector(".dropdown-content");
                if (dropdownContent) dropdownContent.style.background = "rgba(50, 50, 50, 0.95)";

                const dropdownLinks = document.querySelectorAll(".dropdown-content a");
                dropdownLinks.forEach(link => {
                    link.style.color = "#e0e0e0";
                    link.style.backgroundColor = "transparent";
                });

                const usersList = document.getElementById("usersList");
                usersList.style.backgroundColor = "#333";
                usersList.style.color = "#e0e0e0";

                const emojiModal = document.getElementById("emojiModal");
                emojiModal.style.backgroundColor = "#2a2a2a";
                emojiModal.style.borderColor = "#555";

                const editModal = document.getElementById("editModal");
                editModal.style.backgroundColor = "#2a2a2a";
                editModal.style.color = "#e0e0e0";

                themeToggle.textContent = "üî¶ Light Mode";
                themeToggle.style.backgroundColor = "transparent";
                
                const allMsgs = document.querySelectorAll(".message");
                allMsgs.forEach(msg => {
                    if (msg.classList.contains("other")) {
                        msg.style.backgroundColor = "#333";
                        msg.style.color = "#e0e0e0";
                    } else if (msg.classList.contains("you")) {
                        msg.style.backgroundColor = "#0159aa";
                        msg.style.color = "#e0e0e0";
                    }
                });

            } else {
                document.body.style.backgroundColor = "";
                document.body.style.color = "";

                const allText = document.querySelectorAll("p, h1, h2, h3, h4, span");
                allText.forEach(el => {
                    el.style.color = "";
                });

                const inputs = document.querySelectorAll("input[type='text']");
                inputs.forEach(input => {
                    input.style.backgroundColor = "white";
                    input.style.color = "black";
                    input.style.borderColor = "";
                });

                const buttons = document.querySelectorAll("button");
                buttons.forEach(btn => {
                    btn.style.backgroundColor = "";
                    btn.style.color = "";
                });

                themeToggle.textContent = "üåô Dark Mode";
            }
        }

        // Notification Toggle
        const notificationToggle = document.getElementById("notificationToggle");
        notificationToggle.addEventListener("click", () => {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        localStorage.setItem("notifications_enabled", "true");
                        notificationToggle.textContent = "üîî Notifications On";
                    } else {
                        notificationsEnabled = false;
                        localStorage.setItem("notifications_enabled", "false");
                        notificationToggle.textContent = "üîï Notifications Off";
                    }
                });
            }
        });

        notificationToggle.textContent = notificationsEnabled ? "üîî Notifications On" : "üîï Notifications Off";
        applyTheme();

        // Emoji Picker
        const commonEmojis = ['üòÄ', 'üòÇ', 'üòç', 'ü•∞', 'üòò', 'ü§î', 'üòä', 'üî•', 'üëç', 'üëé', '‚ù§Ô∏è', 'üò¢', 'üò°', 'üéâ', 'üéä', 'üéà', '‚≠ê', '‚ú®', '‚òÄÔ∏è', 'üíµ', '‚úàÔ∏è', 'üé¨', 'üò≠', 'ü§®', '‚ö†Ô∏è'];
        const emojiPickerBtn = document.getElementById("emojiPickerBtn");
        const emojiModal = document.getElementById("emojiModal");
        const emojiGrid = document.getElementById("emojiGrid");

        commonEmojis.forEach(emoji => {
            const emojiBtn = document.createElement("button");
            emojiBtn.textContent = emoji;
            emojiBtn.style.fontSize = "24px";
            emojiBtn.style.border = "none";
            emojiBtn.style.cursor = "pointer";
            emojiBtn.style.padding = "5px";
            emojiBtn.style.backgroundColor = darkMode ? "#333" : "white";
            emojiBtn.addEventListener("click", () => {
                document.getElementById("messages").value += emoji;
                emojiModal.style.display = "none";
            });
            emojiGrid.appendChild(emojiBtn);
        });

        emojiPickerBtn.addEventListener("click", () => {
            emojiModal.style.display = emojiModal.style.display === "none" ? "block" : "none";
        });

        document.addEventListener("click", (e) => {
            if (e.target !== emojiPickerBtn && e.target !== emojiModal && !emojiModal.contains(e.target)) {
                emojiModal.style.display = "none";
            }
        });

        // Edit Message Functions
        const editModal = document.getElementById("editModal");
        const editOverlay = document.getElementById("editOverlay");
        const editMessageInput = document.getElementById("editMessageInput");
        const editSaveBtn = document.getElementById("editSaveBtn");
        const editCancelBtn = document.getElementById("editCancelBtn");

        function openEditModal(msgId, currentText) {
            currentEditingMsgId = msgId;
            editMessageInput.value = currentText;
            editModal.style.display = "block";
            editOverlay.style.display = "block";
            editMessageInput.focus();
            editMessageInput.select();
        }

        function closeEditModal() {
            editModal.style.display = "none";
            editOverlay.style.display = "none";
            currentEditingMsgId = null;
            editMessageInput.value = "";
        }

        editSaveBtn.addEventListener("click", async () => {
            const newText = editMessageInput.value.trim();
            if (!newText) {
                alert("Message cannot be empty");
                return;
            }

            const msgDiv = document.getElementById(`msg-${currentEditingMsgId}`);
            const contentDiv = msgDiv.querySelector(".message-content");
            contentDiv.innerHTML = highlightMentions(DOMPurify.sanitize(newText));

            let editedLabel = msgDiv.querySelector(".edited-label");
            if (!editedLabel) {
                editedLabel = document.createElement("span");
                editedLabel.className = "edited-label";
                msgDiv.querySelector(".name").appendChild(editedLabel);
            }
            editedLabel.textContent = "(edited)";

            closeEditModal();
            displaySystemMessage(`${document.getElementById("name").value.trim() || "Anonymous"} edited a message`);
        });

        editCancelBtn.addEventListener("click", closeEditModal);
        editOverlay.addEventListener("click", closeEditModal);
        editMessageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                editSaveBtn.click();
            }
        });

        function displayMessage(msg, includeReactions = true) {
            const nameInput = document.getElementById("name").value.trim() || "Anonymous";
            const isMyMessage = msg.name === nameInput;

            const chat = document.getElementById("chat");
            const msgDiv = document.createElement("div");
            msgDiv.className = isMyMessage ? "message you" : "message other";
            msgDiv.id = `msg-${msg.id || Date.now()}`;
            msgDiv.dataset.messageId = msg.id;

            const nameDiv = document.createElement("div");
            nameDiv.className = "name";
            nameDiv.style.cursor = "pointer";
            nameDiv.title = "Click to view profile of " + msg.name;

            const timeString = formatRelativeTime(msg.timestamp);
            nameDiv.innerHTML = DOMPurify.sanitize(msg.name) + " ‚Ä¢ " + timeString;

            if (msg.avatar) {
                const avatarImg = document.createElement("img");
                avatarImg.src = msg.avatar;
                avatarImg.style.width = "40px";
                avatarImg.style.height = "40px";
                avatarImg.style.borderRadius = "50%";
                avatarImg.style.marginRight = "10px";
                nameDiv.prepend(avatarImg);
            }

            nameDiv.addEventListener("click", () => {
                showUserProfile(msg.name);
            });

            const messageDiv = document.createElement("div");
            messageDiv.innerHTML = highlightMentions(DOMPurify.sanitize(msg.message));
            messageDiv.className = "message-content";

            const reactionsDiv = document.createElement("div");
            reactionsDiv.className = "reactions-container";
            reactionsDiv.style.marginTop = "5px";
            reactionsDiv.style.display = "none";
            reactionsDiv.style.gap = "5px";
            reactionsDiv.style.flexWrap = "wrap";

            const reactionEmojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üî•', 'üò¢'];
            reactionEmojis.forEach(emoji => {
                const reactionBtn = document.createElement("button");
                reactionBtn.textContent = emoji;
                reactionBtn.style.background = "rgba(255,255,255,0.2)";
                reactionBtn.style.border = "none";
                reactionBtn.style.cursor = "pointer";
                reactionBtn.style.padding = "2px 8px";
                reactionBtn.style.borderRadius = "10px";
                reactionBtn.style.fontSize = "14px";
                reactionBtn.addEventListener("click", () => {
                    addReaction(msgDiv, emoji);
                });
                reactionsDiv.appendChild(reactionBtn);
            });

            msgDiv.appendChild(nameDiv);
            msgDiv.appendChild(messageDiv);
            msgDiv.appendChild(reactionsDiv);

            // Show reactions and edit/delete buttons on right-click
            msgDiv.addEventListener("contextmenu", (e) => {
                e.preventDefault();
                reactionsDiv.style.display = reactionsDiv.style.display === "none" ? "flex" : "none";
                if (isMyMessage) {
                    buttonsContainer.style.display = buttonsContainer.style.display === "none" ? "flex" : "none";
                }
            });
            
            // Hide context menu when clicking elsewhere
            document.addEventListener("click", () => {
                reactionsDiv.style.display = "none";
            }, { once: true });

            if (isMyMessage) {
                const buttonsContainer = document.createElement("div");
                buttonsContainer.style.marginTop = "5px";
                buttonsContainer.style.display = "flex";
                buttonsContainer.style.gap = "5px";

                const editBtn = document.createElement("button");
                editBtn.textContent = "‚úèÔ∏è Edit";
                editBtn.style.background = "rgba(0,150,255,0.3)";
                editBtn.style.border = "none";
                editBtn.style.cursor = "pointer";
                editBtn.style.padding = "3px 8px";
                editBtn.style.borderRadius = "5px";
                editBtn.style.fontSize = "12px";
                editBtn.addEventListener("click", () => {
                    const currentText = messageDiv.textContent;
                    openEditModal(msg.id || msgDiv.id.replace('msg-', ''), currentText);
                });
                buttonsContainer.appendChild(editBtn);

                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "üóëÔ∏è Delete";
                deleteBtn.style.background = "rgba(255,0,0,0.3)";
                deleteBtn.style.border = "none";
                deleteBtn.style.cursor = "pointer";
                deleteBtn.style.padding = "3px 8px";
                deleteBtn.style.borderRadius = "5px";
                deleteBtn.style.fontSize = "12px";
                deleteBtn.addEventListener("click", async () => {
                    msgDiv.style.display = "none";
                    displaySystemMessage(`${nameInput} deleted a message`);
                });
                buttonsContainer.appendChild(deleteBtn);

                msgDiv.appendChild(buttonsContainer);
            }

            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;

            allMessages.push(msg);
        }

        function displaySystemMessage(message) {
            const chat = document.getElementById("chat");
            const msgDiv = document.createElement("div");
            msgDiv.className = "message system";
            msgDiv.style.backgroundColor = darkMode ? "#3a3a3a" : "#f0f0f0";
            msgDiv.style.textAlign = "center";
            msgDiv.style.fontStyle = "italic";
            msgDiv.style.color = darkMode ? "#999" : "#666";

            const nameDiv = document.createElement("div");
            nameDiv.className = "name";
            nameDiv.textContent = "System ‚Ä¢ " + formatRelativeTime(new Date().toISOString());

            const messageDiv = document.createElement("div");
            messageDiv.textContent = message;

            msgDiv.appendChild(nameDiv);
            msgDiv.appendChild(messageDiv);
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        function addReaction(msgDiv, emoji) {
            const existingReaction = msgDiv.querySelector(`.reaction[data-emoji="${emoji}"]`);
            if (existingReaction) {
                existingReaction.textContent = emoji + " " + (parseInt(existingReaction.textContent.split(" ")[1]) + 1);
            } else {
                const reactionTag = document.createElement("span");
                reactionTag.className = "reaction";
                reactionTag.dataset.emoji = emoji;
                reactionTag.textContent = emoji + " 1";
                reactionTag.style.background = "rgba(255,255,255,0.3)";
                reactionTag.style.padding = "2px 6px";
                reactionTag.style.borderRadius = "10px";
                reactionTag.style.fontSize = "12px";
                reactionTag.style.marginRight = "5px";
                const reactionsContainer = msgDiv.querySelector(".reactions-container");
                if (reactionsContainer.lastChild) {
                    reactionsContainer.parentNode.insertBefore(reactionTag, reactionsContainer.nextSibling);
                }
            }
        }

        function showUserProfile(userName) {
            const profile = userProfiles[userName] || {};
            const messageCount = allMessages.filter(m => m.name === userName).length;
            const firstMessage = allMessages.find(m => m.name === userName);
            const joinTime = firstMessage ? new Date(firstMessage.timestamp).toLocaleDateString() : "Unknown";

            alert(`üë§ ${userName}\nüìä Messages: ${messageCount}\nüìÖ Joined: ${joinTime}`);
        }

        function updateUsersList() {
            const uniqueUsers = [...new Set(allMessages.map(m => m.name))];
            document.getElementById("onlineCount").textContent = uniqueUsers.length;
            const usersList = document.getElementById("usersList");
            usersList.innerHTML = uniqueUsers.map(user => `<div style="padding: 3px; border-bottom: 1px solid ${darkMode ? '#555' : '#ddd'};">‚úì ${user}</div>`).join("");
            document.getElementById("onlineUsersContainer").style.display = uniqueUsers.length > 0 ? "block" : "none";
        }

        async function fetchOldMessages() {
            try {
                const { data, error } = await client
                    .from('messages_science')
                    .select('*')
                    .order('timestamp', { ascending: true });

                if (error) {
                    console.error("Error fetching old messages:", error);
                    return;
                }

                if (data) {
                    data.forEach(msg => {
                        displayMessage(msg);
                        if (!userProfiles[msg.name]) {
                            userProfiles[msg.name] = { avatar: msg.avatar };
                        }
                    });
                    updateUsersList();
                }
            } catch (err) {
                console.error("An unexpected error occurred while fetching messages:", err);
            }
        }

        fetchOldMessages();

        const badWords = ["fuck", "asshole", "mad", "idiot", "stupid", "dumb", "dogs", "fouls", "fool", "ŸÉŸÑÿ®", "ÿ∫ÿ®Ÿä", "ÿßÿ≠ŸÖŸÇ", "ÿßÿ®ŸÑŸá", "ÿßŸáÿ®ŸÑ", "ŸÖÿ¨ŸÜŸàŸÜ", "ÿ≠ŸÖÿßÿ±"];
        const violations = JSON.parse(localStorage.getItem("violations")) || {};

        client
            .channel('messages-realtime-science')
            .on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'messages_science'
            }, (payload) => {
                const msg = payload.new;
                const nameInput = document.getElementById("name").value.trim() || "Anonymous";

                if (msg.name !== nameInput) {
                    displayMessage(msg);
                    updateUsersList();
                }
            })
            .subscribe();

        window.addEventListener('load', function() {
            const preloader = document.querySelector('.dot-spinner');
            if (preloader) preloader.style.display = 'none';
            bellSound = new Audio('assets/bell.mp3');
        });

        function showNotification(title, body) {
            if (Notification.permission === 'granted' && notificationsEnabled) {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'assets/logo.png',
                    silent: false
                });

                notification.onclick = function() {
                    window.focus();
                };
            }
        }

        const audio = new Audio('assets/notifacation.mp3');

        function playNotificationSound() {
            if (notificationsEnabled) {
                audio.currentTime = 0;
                audio.play().catch(e => console.error("Error playing sound:", e));
            }
        }

        function markMessageAsSeen(msgId, viewer) {
            const msgDiv = document.getElementById(`msg-${msgId}`);
            if (!msgDiv || !viewer) return;

            if (!seenMessages.has(msgId)) {
                seenMessages.set(msgId, new Set());
            }

            const viewers = seenMessages.get(msgId);

            if (viewers.has(viewer)) return;

            viewers.add(viewer);

            let seenDiv = msgDiv.querySelector(".seen-by");
            if (!seenDiv) {
                seenDiv = document.createElement("div");
                seenDiv.className = "seen-by";
                seenDiv.style.fontSize = "11px";
                seenDiv.style.color = "#0159aa";
                seenDiv.style.marginTop = "3px";
                seenDiv.style.fontStyle = "italic";
                msgDiv.appendChild(seenDiv);
            }

            seenDiv.textContent = "üëÅÔ∏è Seen by: " + Array.from(viewers).join(", ");
        }

        // Optimized: Only send seen status when user is actively viewing (increased interval to 5 seconds)
        // and limit to only visible messages
        let lastSeenCheck = 0;
        const SEEN_CHECK_INTERVAL = 5000; // 5 seconds instead of 1 second

        function checkMessagesSeen() {
            const now = Date.now();
            if (now - lastSeenCheck < SEEN_CHECK_INTERVAL) return;
            lastSeenCheck = now;

            const nameInput = document.getElementById("name").value.trim() || "Anonymous";
            const messageElements = document.querySelectorAll("[data-message-id]");

            // Only process visible messages to reduce load
            let count = 0;
            messageElements.forEach(el => {
                if (count >= 10) return; // Limit to 10 messages per check
                
                const msgId = el.dataset.messageId;
                client.channel('seen-status').send({
                    type: 'broadcast',
                    event: 'message-seen',
                    payload: {
                        msgId: msgId,
                        viewer: nameInput,
                        timestamp: new Date().toISOString()
                    }
                }).catch(() => {});
                count++;
            });
        }

        // Call on user activity instead of continuous interval
        document.addEventListener('scroll', checkMessagesSeen, { passive: true });
        document.addEventListener('click', checkMessagesSeen);
        setInterval(checkMessagesSeen, SEEN_CHECK_INTERVAL);

        document.getElementById("recordBtn").addEventListener("click", async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mimeType = MediaRecorder.isTypeSupported('audio/ogg') ? 'audio/ogg' : 'audio/webm';
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.start();
                console.log("üéôÔ∏è Recording started");
            } catch (err) {
                alert("‚ùå Microphone access is required to record audio.");
            }
        });

        document.getElementById("stopBtn").addEventListener("click", () => {
            if (!mediaRecorder || mediaRecorder.state !== "recording") {
                alert("‚ùå You must start recording before stopping.");
                return;
            }

            mediaRecorder.stop();

            mediaRecorder.onstop = async () => {
                const mimeType = mediaRecorder.mimeType;
                const extension = mimeType.includes('ogg') ? 'ogg' : 'webm';
                const audioBlob = new Blob(audioChunks, { type: mimeType });

                if (audioBlob.size === 0) {
                    alert("‚ùå The audio file is empty and cannot be uploaded.");
                    return;
                }

                let fileName = `voice_${Date.now()}.${extension}`;
                fileName = fileName.replace(/[^a-zA-Z0-9_\u0600-\u06FF.]/g, '_');

                const { data: uploadData, error: uploadError } = await client.storage
                    .from('voice_notes')
                    .upload(fileName, audioBlob, { contentType: mimeType });

                if (uploadError || !uploadData) {
                    alert("‚ùå Upload failed: " + (uploadError?.message || "Unknown error"));
                    return;
                }

                const { data: publicData } = client.storage
                    .from('voice_notes')
                    .getPublicUrl(fileName);

                const publicUrl = publicData.publicUrl;
                const nameInput = document.getElementById("name").value.trim();
                currentUser = nameInput || "Anonymous";

                const { error: dbError } = await client
                    .from('voice_messages')
                    .insert([{
                        name: currentUser,
                        audio_url: publicUrl,
                        timestamp: new Date().toISOString()
                    }]);

                if (dbError) {
                    alert("‚ùå Failed to save message: " + dbError.message);
                    return;
                }

                const chat = document.getElementById("chat");
                const msgDiv = document.createElement("div");
                msgDiv.className = "message you";

                const nameDiv = document.createElement("div");
                nameDiv.className = "name";
                nameDiv.textContent = currentUser + " ‚Ä¢ " + formatRelativeTime(new Date().toISOString());

                const audioPlayer = document.createElement("audio");
                audioPlayer.controls = true;
                audioPlayer.style.width = "100%";

                const source = document.createElement("source");
                source.src = publicUrl;
                source.type = mimeType;

                audioPlayer.appendChild(source);
                audioPlayer.innerHTML += "Your browser does not support audio playback.";

                msgDiv.appendChild(nameDiv);
                msgDiv.appendChild(audioPlayer);
                chat.appendChild(msgDiv);
                chat.scrollTop = chat.scrollHeight;
            };
        });

        document.getElementById("avatarBtn").addEventListener("click", () => {
            document.getElementById("avatar").click();
        });

        document.getElementById("sendBtn").addEventListener("click", async () => {
            const nameInput = document.getElementById("name").value.trim();
            const messageInput = document.getElementById("messages").value.trim();
            const avatarFile = document.getElementById("avatar").files[0];

            if (!messageInput) {
                alert("‚ùå you must enter a message before sending.");
                return;
            }

            const name = nameInput || "Anonymous";
            const lowerMessage = messageInput.toLowerCase();
            const containsBadWord = badWords.some(word => lowerMessage.includes(word));
            const userViolations = violations[name] || { count: 0, bannedUntil: null };
            const now = Date.now();

            if (userViolations.bannedUntil && now < userViolations.bannedUntil) {
                alert("‚ùå you are currently banned from sending messages.");
                return;
            }

            if (containsBadWord) {
                userViolations.count += 1;
                if (userViolations.count === 1) {
                    alert("‚ö†Ô∏è inappropriate language detected. This is your first warning.");
                } else if (userViolations.count >= 3) {
                    userViolations.bannedUntil = now + 5 * 60 * 1000;
                    displaySystemMessage(`üö´ ${name} has been banned for 5 minutes.`);
                    alert("üö´ you are banned for 5 minutes");
                }
                violations[name] = userViolations;
                localStorage.setItem("violations", JSON.stringify(violations));
                return;
            }

            let avatarUrl = "";
            if (avatarFile) {
                const avatarFileName = `avatar_${Date.now()}_${avatarFile.name}`.replace(/[^a-zA-Z0-9_.]/g, '_');
                const { data: uploadData, error: uploadError } = await client.storage
                    .from('avatars')
                    .upload(avatarFileName, avatarFile, { contentType: avatarFile.type });
                if (uploadError) {
                    alert("‚ùå error uploading avatar: " + uploadError.message);
                    return;
                }

                const { data: publicData } = client.storage
                    .from('avatars')
                    .getPublicUrl(avatarFileName);
                avatarUrl = publicData.publicUrl;
            }

            const timestamp = new Date().toISOString();
            const { error: dbError } = await client
                .from('messages')
                .insert([{
                    name: name,
                    message: messageInput,
                    avatar: avatarUrl,
                    timestamp: timestamp
                }]);

            if (dbError) {
                alert("‚ùå Failed to send message: " + dbError.message);
                return;
            }

            const sentMessageData = {
                name: name,
                message: messageInput,
                avatar: avatarUrl,
                timestamp: timestamp
            };
            displayMessage(sentMessageData);
            updateUsersList();

            document.getElementById("messages").value = "";
            document.getElementById("avatar").value = "";
        });
    </script>
</body>
</html>