<!DOCTYPE html>
<head>
    <meta name="google-site-verification" content="q_vJ_negIqtaZpzVtg0aMM9CNBFzAuNxlm2kTpHXAtA" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000" rel="stylesheet">
    <meta charset="UTF-8">
    <title>Dalifos¬© Chat (Beta Release)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="assets/logo.png" type="image/x-icon">
</head>
<body>
    <div class="navbar">
        <a href="index.html"><img src="assets/logo.png" alt="Dalifos Logo" class="logo"></a>
        <h1>Dalifos¬© Chat Beta   </h1>
        <div class="dropdown">
            <button class="dropbtn">...</button>
            <div class="dropdown-content">
                       <p>options</p>
                <a href="whats new in Dalifos chat.html" title="what's new in Dalifos chat"><img src="assets/logo.png">what's new</a>
                <a href="https://forms.gle/HfwsYZVLD84mia2b8" title="report errors"><img src="assets/error-svgrepo-com.svg">report errors</a>
                <a href="channel.html" title="youtube channel"><img src="assets/YouTube-logo.png">youtube channel</a>
                <a href="FAQ.html" title="frequently asked questions"><img src="assets/FAQ.png">FAQ</a>
                       <p>chats</p>
                            <a href="#" title="private chat" style="cursor: not-allowed;"><img
                src="assets/private-message-svgrepo-com.svg"> &gt;private chat (Coming Soon)</a>
            <a href="#" title="private group (not created)" style="cursor: not-allowed;"><img
                src="assets/group-chat-svgrepo-com.svg">private group chat (comming soon)</a>
            <a href="index.html" title="public chat"><img src="assets/public-opened-svgrepo-com.svg">public chat </a>
            <a href="chat_AI" title="AI chat"><img src="assets/Ai.png">AI chat</a>
                          <p>other progects</p>
                <a href="https://dodo-e.github.io/dalifos-website/" title="Dalifos main web"><img src="assets/logo main.png">Dalifos¬©
                    web</a>
                <a href="index.html" title="Dalifos¬© chat"><img src="assets/public-opened-svgrepo-com.svg">Dalifos¬© chat</a>
                <a href="https://dodo-e.github.io/Dalifos-BD1/" title="Dalifos¬© BD1"><img src="assets/logo (2).png">Dalifos¬© BD1</a>
    </div>
        </div>

            </div>
        </div>
    </div>
        </div></div></div>
    <h2>üí¨ Dalifos Chat Beta 4.2 üí¨</h2>
    <div id="chat">
        </div>
    <br>
    <input type="file" id="avatar" accept="image/*" style="display: none;">
    <button type="button" id="avatarBtn" title="Choose an avatar (optional)">
        <img src="assets/avatar-default-svgrepo-com.svg" alt="choose avatar" class="avatar-icon">
    </button>
    <input type="text" id="name" placeholder="name" title="Enter your name">
    <input type="text" id="messages" placeholder="Type here" title="Type your message here">
    <button id="sendBtn"><img src="assets/paper-plane-tilt-fill-svgrepo-com.svg" title="Send"></button>
    <br>
    <button id="recordBtn"><img src="assets/microphone-sensitivity-high-svgrepo-com.svg" title="start voice note" ></button>
    <button id="stopBtn"><img src="assets/microphone-disabled-svgrepo-com.svg" title="stop voice note"></button>
    <button id="soundButton"><img src="assets/emoji-flags-svgrepo-com.svg" title="make like a wake for chat"></button>
    <h3><b>do not share any personal data because some data may be seen by company</b></h3>
    <h3>note: this website is beta, so if you see an error, please report it </h3>
    <script>
        window.addEventListener("DOMContentLoaded", () => {
            const navbar = document.querySelector(".navbar");
            const hideBtn = document.createElement("button");
            hideBtn.id = "hideNavbarBtn";
            hideBtn.textContent = "‚ò∞";
            hideBtn.style.position = "fixed";
            hideBtn.style.top = "10px";
            hideBtn.style.right = "10px";
            hideBtn.style.zIndex = "1001";
            hideBtn.style.padding = "8px 12px";
            hideBtn.style.backgroundColor = "#333";
            hideBtn.style.color = "#fff";
            hideBtn.style.border = "none";
            hideBtn.style.borderRadius = "5px";
            hideBtn.style.cursor = "pointer";
            document.body.appendChild(hideBtn);

            hideBtn.addEventListener("click", () => {
            navbar.style.display = navbar.style.display === "none" ? "block" : "none";
            });

            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            if (isSafari) {
            const warning = document.createElement("div");
            warning.textContent = "‚ö†Ô∏è Iphone is beta. Please use android for the best experience.";
            warning.style.backgroundColor = "#ffcc00";
            warning.style.color = "black";
            warning.style.padding = "10px";
            warning.style.borderRadius = "10px";
            warning.style.marginBottom = "10px";
            warning.style.fontWeight = "bold";
            document.body.insertBefore(warning, document.body.firstChild);
            }

            if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                console.log("notefacation permission granted.");
                } else if (permission === 'denied') {
                console.log("notefacation permission denied.");
                }
            });
            }

            function showNotification(title, body) {
            if (Notification.permission === 'granted') {
                const notification = new Notification(title, {
                body: body,
                icon: 'https://dodo-e.github.io/dalifos-website/logo.png',
                silent: true
                });

                notification.onclick = function () {
                window.focus();
                };
            }
            }

            const audio = new Audio('assets/notifacation.mp3');

            function playNotificationSound() {
            audio.currentTime = 0;
            audio.play().catch(e => console.error("Error playing sound:", e));
            }

            const bellSound = new Audio('assets/bell.mp3');

            const supabaseUrl = 'https://auojqvmbgbpfkoatkvkl.supabase.co';
            const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1b2pxdm1iZ2JwZmtvYXRrdmtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzkzMzIsImV4cCI6MjA3MTAxNTMzMn0.FkqEo9BWHkBixdoQ2vEJdpZ-34l77L0Inbh62AIRFG4';
            const client = window.supabase.createClient(supabaseUrl, anonKey);

            const savedName = localStorage.getItem("chat_name");
            const savedAvatar = localStorage.getItem("chat_avatar");

            if (savedName) {
            document.getElementById("name").value = savedName;
            }

            function displayMessage(msg) {
            const nameInput = document.getElementById("name").value.trim() || "Anonymous";
            const isMyMessage = msg.name === nameInput;

            const chat = document.getElementById("chat");
            const msgDiv = document.createElement("div");
            msgDiv.className = isMyMessage ? "message you" : "message other";

            const nameDiv = document.createElement("div");
            nameDiv.className = "name";
            nameDiv.textContent = msg.name + " ‚Ä¢ " + new Date(msg.timestamp).toLocaleTimeString();

            if (msg.avatar) {
                const avatarImg = document.createElement("img");
                avatarImg.src = msg.avatar;
                avatarImg.style.width = "40px";
                avatarImg.style.height = "40px";
                avatarImg.style.borderRadius = "50%";
                avatarImg.style.marginRight = "10px";
                nameDiv.prepend(avatarImg);
            }

            const messageDiv = document.createElement("div");
            messageDiv.textContent = msg.message;

            msgDiv.appendChild(nameDiv);
            msgDiv.appendChild(messageDiv);
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
            }

            function displaySystemMessage(message) {
            const chat = document.getElementById("chat");
            const msgDiv = document.createElement("div");
            msgDiv.className = "message system";
            msgDiv.style.backgroundColor = "#f0f0f0";
            msgDiv.style.textAlign = "center";
            msgDiv.style.fontStyle = "italic";
            msgDiv.style.color = "#666";

            const nameDiv = document.createElement("div");
            nameDiv.className = "name";
            nameDiv.textContent = "System ‚Ä¢ " + new Date().toLocaleTimeString();

            const messageDiv = document.createElement("div");
            messageDiv.textContent = message;

            msgDiv.appendChild(nameDiv);
            msgDiv.appendChild(messageDiv);
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
            }

            async function fetchOldMessages() {
            try {
                const { data, error } = await client
                .from('messages')
                .select('*')
                .order('timestamp', { ascending: true });

                if (error) {
                console.error("Error fetching old messages:", error);
                return;
                }

                if (data) {
                data.forEach(msg => displayMessage(msg));
                }
            } catch (err) {
                console.error("An unexpected error occurred while fetching messages:", err);
            }
            }

            fetchOldMessages();

            const badWords = ["fuck", "asshole", "mad", "idiot", "stupid", "dumb", "dogs", "fouls", "fool", "ŸÉŸÑÿ®", "ÿ∫ÿ®Ÿä", "ÿ£ÿ≠ŸÖŸÇ", "ÿ£ÿ®ŸÑŸá", "ÿ£Ÿáÿ®ŸÑ", "ŸÖÿ¨ŸÜŸàŸÜ", "ÿ≠ŸÖÿßÿ±", "ÿ£ÿ≠ŸÖŸÇ", "ÿ∫ÿ®Ÿä ÿ¨ÿØÿß", "ÿ£ÿ®ŸÑŸá ÿ¨ÿØÿß", "ÿ£Ÿáÿ®ŸÑ ÿ¨ÿØÿß", "ŸÖÿ¨ŸÜŸàŸÜ ÿ¨ÿØÿß", "ÿ≠ŸÖÿßÿ± ÿ¨ÿØÿß", "ÿ£ŸÜÿ™ ÿ∫ÿ®Ÿä", "ÿ£ŸÜÿ™ ÿ£ÿ≠ŸÖŸÇ", "ÿ£ŸÜÿ™ ÿ£ÿ®ŸÑŸá", "ÿ£ŸÜÿ™ ÿ£Ÿáÿ®ŸÑ", "ÿ£ŸÜÿ™ ŸÖÿ¨ŸÜŸàŸÜ", "ÿ£ŸÜÿ™ ÿ≠ŸÖÿßÿ±", "ü§Æ", "üí©", "üñïüèº"];
            const violations = JSON.parse(localStorage.getItem("violations")) || {};

            client
            .channel('messages-realtime')
            .on(
                'postgres_changes',
                {
                event: 'INSERT',
                schema: 'public',
                table: 'messages'
                },
                (payload) => {
                const msg = payload.new;
                const nameInput = document.getElementById("name").value.trim() || "Anonymous";

                if (msg.name !== nameInput) {
                    displayMessage(msg);
                    showNotification("ÿ±ÿ≥ÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ " + msg.name, msg.message);
                    playNotificationSound();
                }
                }
            )
            .subscribe();

            let mediaRecorder;
            let audioChunks = [];
            let currentUser = "";

            document.getElementById("recordBtn").addEventListener("click", async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mimeType = MediaRecorder.isTypeSupported('audio/ogg') ? 'audio/ogg' : 'audio/webm';
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
                };

                mediaRecorder.start();
                console.log("üéôÔ∏è Recording started");
            } catch (err) {
                alert("‚ùå Microphone access is required to record audio.");
            }
            });

            document.getElementById("stopBtn").addEventListener("click", () => {
            if (!mediaRecorder || mediaRecorder.state !== "recording") {
                alert("‚ùå You must start recording before stopping.");
                return;
            }

            mediaRecorder.stop();
            console.log("üõë Recording stopped");

            mediaRecorder.onstop = async () => {
                const mimeType = mediaRecorder.mimeType;
                const extension = mimeType.includes('ogg') ? 'ogg' : 'webm';
                const audioBlob = new Blob(audioChunks, { type: mimeType });

                if (audioBlob.size === 0) {
                alert("‚ùå The audio file is empty and cannot be uploaded.");
                return;
                }

                let fileName = `voice_${Date.now()}.${extension}`;
                fileName = fileName.replace(/[^a-zA-Z0-9_\u0600-\u06FF.]/g, '_');

                const { data: uploadData, error: uploadError } = await client.storage
                .from('voice_notes')
                .upload(fileName, audioBlob, {
                    contentType: mimeType
                });

                if (uploadError || !uploadData) {
                alert("‚ùå Upload failed. Please report this error: " + (uploadError?.message || "Unknown error"));
                return;
                }

                const { data: publicData, error: publicUrlError } = client.storage
                .from('voice_notes')
                .getPublicUrl(fileName);

                if (publicUrlError || !publicData?.publicUrl) {
                alert("‚ùå Failed to get public URL. Please report this error.");
                return;
                }

                const publicUrl = publicData.publicUrl;
                const nameInput = document.getElementById("name").value.trim();
                currentUser = nameInput || "Anonymous";

                const { error: dbError } = await client
                .from('voice_messages')
                .insert([
                    {
                    name: currentUser,
                    audio_url: publicUrl,
                    timestamp: new Date().toISOString()
                    }
                ]);

                if (dbError) {
                alert("‚ùå Failed to save message. Please report this error: " + dbError.message);
                return;
                }

                const chat = document.getElementById("chat");
                const msgDiv = document.createElement("div");
                msgDiv.className = "message you";

                const nameDiv = document.createElement("div");
                nameDiv.className = "name";
                nameDiv.textContent = currentUser + " ‚Ä¢ " + new Date().toLocaleTimeString();

                const audioPlayer = document.createElement("audio");
                audioPlayer.controls = true;
                audioPlayer.style.width = "100%";

                const source = document.createElement("source");
                source.src = publicUrl;
                source.type = mimeType;

                audioPlayer.appendChild(source);
                audioPlayer.innerHTML += "Your browser does not support audio playback.";

                msgDiv.appendChild(nameDiv);
                msgDiv.appendChild(audioPlayer);
                chat.appendChild(msgDiv);
                chat.scrollTop = chat.scrollHeight;
            };
            });

            document.getElementById("avatarBtn").addEventListener("click", () => {
            document.getElementById("avatar").click();
            });

            document.getElementById("sendBtn").addEventListener("click", async () => {
            const nameInput = document.getElementById("name").value.trim();
            const messageInput = document.getElementById("messages").value.trim();
            const avatarFile = document.getElementById("avatar").files[0];

            if (!messageInput) {
                alert("‚ùå you must enter a message before sending.");
                return;
            }

            const name = nameInput || "Anonymous";
            const lowerMessage = messageInput.toLowerCase();
            const containsBadWord = badWords.some(word => lowerMessage.includes(word));
            const userViolations = violations[name] || { count: 0, bannedUntil: null };
            const now = Date.now();

            if (userViolations.bannedUntil && now < userViolations.bannedUntil) {
                alert("‚ùå you are currently banned from sending messages. Please wait 5 minutes until the ban expires.");
                return;
            }

            if (containsBadWord) {
                userViolations.count += 1;
                if (userViolations.count === 1) {
                alert("‚ö†Ô∏è inappropriate language detected. This is your first warning.after 3 warnings, you will be banned for 5 minutes.");
                } else if (userViolations.count >= 3) {
                userViolations.bannedUntil = now + 5 * 60 * 1000;
                displaySystemMessage(`üö´ ${name} has been banned for 5 minutes due to inappropriate language.`);
                alert("üö´ you are banned from using massaging for 5 minutes because of using inappropriate words a lot");
                }
                violations[name] = userViolations;
                localStorage.setItem("violations", JSON.stringify(violations));
                return;
            }

            let avatarUrl = "";
            if (avatarFile) {
                const avatarFileName = `avatar_${Date.now()}_${avatarFile.name}`.replace(/[^a-zA-Z0-9_.]/g, '_');
                const { data: uploadData, error: uploadError } = await client.storage
                .from('avatars')
                .upload(avatarFileName, avatarFile, {
                    contentType: avatarFile.type
                });
                if (uploadError) {
                alert("‚ùå error uploading avatar.report this error: " + uploadError.message);
                return;
                }

                const { data: publicData } = client.storage
                .from('avatars')
                .getPublicUrl(avatarFileName);
                avatarUrl = publicData.publicUrl;
            }

            const timestamp = new Date().toISOString(); 
            const { error: dbError } = await client
                .from('messages')
                .insert([
                {
                    name: name,
                    message: messageInput,
                    avatar: avatarUrl,
                    timestamp: timestamp 
                }
                ]);
            
            if (dbError) {
                alert("‚ùå Failed to send message: " + dbError.message);
                return;
            }

            const sentMessageData = {
                name: name,
                message: messageInput,
                avatar: avatarUrl,
                timestamp: timestamp
            };
            displayMessage(sentMessageData);

            document.getElementById("messages").value = "";
            document.getElementById("avatar").value = "";

            });

            const soundButton = document.getElementById('soundButton');

            client.channel('chat-events')
            .on('broadcast', { event: 'ring-bell' }, (payload) => {
                bellSound.play().catch(e => console.error("Error playing bell sound:", e));
                showNotification("üîî Bell Ring", `${payload.payload.name} pressed the sound button`);
                displaySystemMessage(`üîî ${payload.payload.name} rang the bell`);
                console.log('üîî Received bell ring from:', payload.payload.name);
            })
            .subscribe();

            soundButton.addEventListener('click', async () => {
            const name = document.getElementById("name").value.trim() || "Anonymous";

            const { error } = await client.channel('chat-events').send({
                type: 'broadcast',
                event: 'ring-bell',
                payload: { name: name }
            });

            if (error) {
                console.error('Error sending bell broadcast:', error);
            }

            // Monitor Supabase real-time connection status
            const connectionStatus = document.createElement("div");
            connectionStatus.id = "connection-status";
            connectionStatus.style.display = "none";
            connectionStatus.style.backgroundColor = "#ff6b6b";
            connectionStatus.style.color = "white";
            connectionStatus.style.padding = "12px";
            connectionStatus.style.borderRadius = "5px";
            connectionStatus.style.marginBottom = "10px";
            connectionStatus.style.textAlign = "center";
            connectionStatus.style.fontWeight = "bold";
            document.body.insertBefore(connectionStatus, document.getElementById("chat"));

            client.channel('messages-realtime').on('system', { event: '*' }, (payload) => {
                if (payload.type === 'SYSTEM' && (payload.message?.type === 'CHANNEL_ERROR' || payload.message?.type === 'SOCKET_ERROR')) {
                    connectionStatus.textContent = "‚ö†Ô∏è Connection lost. Attempting to reconnect...";
                    connectionStatus.style.display = "block";
                    displaySystemMessage("‚ö†Ô∏è Connection issues detected. Some messages may not be received. please check your internet connection or contact us on report errors fastly.");
                }
            }).subscribe();

            // Check connection status periodically
            setInterval(() => {
                const state = client.getChannels()[0]?.state;
                if (state === 'joined') {
                    connectionStatus.style.display = "none";
                } else if (state === 'errored' || state === 'left') {
                    connectionStatus.textContent = "‚ö†Ô∏è Connection lost. Attempting to reconnect...";
                    connectionStatus.style.display = "block";
                }
            }, 3000);
            });
        });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
        <script>
            // Update displayMessage function to sanitize content
            const originalDisplayMessage = displayMessage;
            displayMessage = function(msg) {
            const nameInput = document.getElementById("name").value.trim() || "Anonymous";
            const isMyMessage = msg.name === nameInput;

            const chat = document.getElementById("chat");
            const msgDiv = document.createElement("div");
            msgDiv.className = isMyMessage ? "message you" : "message other";

            const nameDiv = document.createElement("div");
            nameDiv.className = "name";
            nameDiv.innerHTML = DOMPurify.sanitize(msg.name) + " ‚Ä¢ " + new Date(msg.timestamp).toLocaleTimeString();

            if (msg.avatar) {
                const avatarImg = document.createElement("img");
                avatarImg.src = msg.avatar;
                avatarImg.style.width = "40px";
                avatarImg.style.height = "40px";
                avatarImg.style.borderRadius = "50%";
                avatarImg.style.marginRight = "10px";
                nameDiv.prepend(avatarImg);
            }

            const messageDiv = document.createElement("div");
            messageDiv.innerHTML = DOMPurify.sanitize(msg.message);

            msgDiv.appendChild(nameDiv);
            msgDiv.appendChild(messageDiv);
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
            };
        </script>

    </script>


</body>
