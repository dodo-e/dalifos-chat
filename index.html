<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dalifos¬© Chat (Beta Release)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="shortcut icon" href="logo.png" type="image/x-icon">
</head>
<body>
  <div class="navbar">
    <img src="logo.png" alt="Dalifos Logo" class="logo">
    <h1>Dalifos¬© Chat Beta</h1>
    <h2>chats</h2> 
    <a href="private.html" title="private chat (under construction)"> <button><img src="private-message-svgrepo-com.svg"></button></a>
    <a href="private-group.html" title="private group (under construction)"><button> <img src="group-chat-svgrepo-com.svg"></button></a>
    <a href="index.html" title="public chat"><button><img src="public-opened-svgrepo-com.svg"></button> </a>
    <h2>errors reporter</h2>
    <a href="https://forms.gle/HfwsYZVLD84mia2b8" title="report errors"> <button><img src="error-svgrepo-com.svg"></button></a>
    <h2>Dalifos¬© progects</h2>
    <a href="https://dodo-e.github.io/dalifos-website/" title="Dalifos main web"><button><img src="logo main.png"></button> </a>
  </div>
<h2>üí¨ Dalifos Chat Beta</h2>
<div id="chat"></div>
<br>
<br>
<input type="file" id="avatar" accept="image/*" style="display: none;">
<button type="button" id="avatarBtn" title="Choose an avatar (optional)">
  <img src="avatar-svgrepo-com.svg" alt="choose avatar" class="avatar-icon" />
</button>
<input type="text" id="name" placeholder="Your name" title="Enter your name">
<input type="text" id="messages" placeholder="Type a message" title="Type your message here">
<button id="sendBtn"><img src="send-svgrepo-com.svg" title="Send"></button>
<br><br>
<button id="clearBtn" title="Clear all messages"><img src="bin-svgrepo-com.svg"></button>
<button id="recordBtn"><img src="play-svgrepo-com.svg"></button>
<button id="stopBtn"><img src="stop-circle-svgrepo-com.svg"></button>
<h3>note:this website is beta, so if you see an error.please report it/do not share any personal data because some data may be seen by company</h3>
<h3>by devoloper of Dalifos: David</h3>
<script>
window.addEventListener("DOMContentLoaded", () => {
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  if (isSafari) {
    const warning = document.createElement("div");
    warning.textContent = "‚ö†Ô∏è Safari is not supported. Please use Chrome, Firefox, or Edge for the best experience.";
    warning.style.backgroundColor = "#ffcc00";
    warning.style.color = "black";
    warning.style.padding = "10px";
    warning.style.borderRadius = "10px";
    warning.style.marginBottom = "10px";
    warning.style.fontWeight = "bold";
    document.body.insertBefore(warning, document.body.firstChild);
  }

  const supabaseUrl = 'https://auojqvmbgbpfkoatkvkl.supabase.co';
  const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1b2pxdm1iZ2JwZmtvYXRrdmtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzkzMzIsImV4cCI6MjA3MTAxNTMzMn0.FkqEo9BWHkBixdoQ2vEJdpZ-34l77L0Inbh62AIRFG4';
  const client = window.supabase.createClient(supabaseUrl, anonKey);

  const savedName = localStorage.getItem("chat_name");
  const savedAvatar = localStorage.getItem("chat_avatar");

  if (savedName) {
    document.getElementById("name").value = savedName;
  }

  const badWords = ["fuck", "asshole", "mad" , "idiot", "stupid", "dumb", "hell", "dogs", "fouls", "fool","ŸÉŸÑÿ®", "ŸÉŸÑÿ®", "ÿ∫ÿ®Ÿä", "ÿ£ÿ≠ŸÖŸÇ", "ÿ£ÿ®ŸÑŸá", "ÿ£Ÿáÿ®ŸÑ", "ŸÖÿ¨ŸÜŸàŸÜ", "ÿ≠ŸÖÿßÿ±", "ÿ£ÿ≠ŸÖŸÇ", "ÿ∫ÿ®Ÿä ÿ¨ÿØÿß", "ÿ£ÿ®ŸÑŸá ÿ¨ÿØÿß", "ÿ£Ÿáÿ®ŸÑ ÿ¨ÿØÿß", "ŸÖÿ¨ŸÜŸàŸÜ ÿ¨ÿØÿß", "ÿ≠ŸÖÿßÿ± ÿ¨ÿØÿß", "ÿ£ŸÜÿ™ ÿ∫ÿ®Ÿä", "ÿ£ŸÜÿ™ ÿ£ÿ≠ŸÖŸÇ", "ÿ£ŸÜÿ™ ÿ£ÿ®ŸÑŸá", "ÿ£ŸÜÿ™ ÿ£Ÿáÿ®ŸÑ", "ÿ£ŸÜÿ™ ŸÖÿ¨ŸÜŸàŸÜ", "ÿ£ŸÜÿ™ ÿ≠ŸÖÿßÿ±","ü§Æ","üí©","üñïüèº"];
  const violations = JSON.parse(localStorage.getItem("violations")) || {};

  client
    .channel('messages-realtime')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'messages'
      },
      (payload) => {
        const msg = payload.new;
        const nameInput = document.getElementById("name").value.trim() || "Anonymous";
        if (msg.name === nameInput) return;

        const chat = document.getElementById("chat");
const msgDiv = document.createElement("div");
msgDiv.className = msg.name === "üö® ÿßŸÑŸÜÿ∏ÿßŸÖ" ? "message system" : "message other";
        msgDiv.className = "message other";

        const nameDiv = document.createElement("div");
        nameDiv.className = "name";
        nameDiv.textContent = msg.name + " ‚Ä¢ " + new Date(msg.timestamp).toLocaleTimeString();

        if (msg.avatar) {
          const avatarImg = document.createElement("img");
          avatarImg.src = msg.avatar;
          avatarImg.style.width = "40px";
          avatarImg.style.borderRadius = "50%";
          avatarImg.style.marginRight = "10px";
          nameDiv.prepend(avatarImg);
        }

        const messageDiv = document.createElement("div");
        messageDiv.textContent = msg.message;

        msgDiv.appendChild(nameDiv);
        msgDiv.appendChild(messageDiv);
        chat.appendChild(msgDiv);
        chat.scrollTop = chat.scrollHeight;
      }
    )
    .subscribe();

  let mediaRecorder;
  let audioChunks = [];
  let currentUser = "";

  document.getElementById("recordBtn").addEventListener("click", async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mimeType = MediaRecorder.isTypeSupported('audio/ogg') ? 'audio/ogg' : 'audio/webm';
      mediaRecorder = new MediaRecorder(stream, { mimeType });
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.start();
      console.log("üéôÔ∏è Recording started");
    } catch (err) {
      alert("‚ùå Microphone access is required to record audio.");
    }
  });

  document.getElementById("stopBtn").addEventListener("click", () => {
    if (!mediaRecorder || mediaRecorder.state !== "recording") {
      alert("‚ùå You must start recording before stopping.");
      return;
    }

    mediaRecorder.stop();
    console.log("üõë Recording stopped");

    mediaRecorder.onstop = async () => {
      const mimeType = mediaRecorder.mimeType;
      const extension = mimeType.includes('ogg') ? 'ogg' : 'webm';
      const audioBlob = new Blob(audioChunks, { type: mimeType });

      if (audioBlob.size === 0) {
        alert("‚ùå The audio file is empty and cannot be uploaded.");
        return;
      }

      let fileName = `voice_${Date.now()}.${extension}`;
      fileName = fileName.replace(/[^a-zA-Z0-9_\u0600-\u06FF.]/g, '_');

      const { data: uploadData, error: uploadError } = await client.storage
        .from('voice_notes')
        .upload(fileName, audioBlob, {
          contentType: mimeType
        });

      if (uploadError || !uploadData) {
        alert("‚ùå Upload failed. Please report this error: " + (uploadError?.message || "Unknown error"));
        return;
      }

      const { data: publicData, error: publicUrlError } = client.storage
        .from('voice_notes')
        .getPublicUrl(fileName);

      if (publicUrlError || !publicData?.publicUrl) {
        alert("‚ùå Failed to get public URL. Please report this error.");
        return;
      }

      const publicUrl = publicData.publicUrl;
      const nameInput = document.getElementById("name").value.trim();
      currentUser = nameInput || "Anonymous";

      const { error: dbError } = await client
        .from('voice_messages')
        .insert([
          {
            name: currentUser,
            audio_url: publicUrl,
            timestamp: new Date().toISOString()
          }
        ]);

      if (dbError) {
        alert("‚ùå Failed to save message. Please report this error: " + dbError.message);
        return;
      }

      const chat = document.getElementById("chat");
      const msgDiv = document.createElement("div");
      msgDiv.className = "message you";

      const nameDiv = document.createElement("div");
      nameDiv.className = "name";
      nameDiv.textContent = currentUser + " ‚Ä¢ " + new Date().toLocaleTimeString();

      const audioPlayer = document.createElement("audio");
      audioPlayer.controls = true;
      audioPlayer.style.width = "100%";

      const source = document.createElement("source");
      source.src = publicUrl;
      source.type = mimeType;

      audioPlayer.appendChild(source);
      audioPlayer.innerHTML += "Your browser does not support audio playback.";

      msgDiv.appendChild(nameDiv);
      msgDiv.appendChild(audioPlayer);
      chat.appendChild(msgDiv);
      chat.scrollTop = chat.scrollHeight;
    };
  });

  document.getElementById("avatarBtn").addEventListener("click", () => {
    document.getElementById("avatar").click();
  });

  document.getElementById("sendBtn").addEventListener("click", async () => {
    const nameInput = document.getElementById("name").value.trim();
    const messageInput = document.getElementById("messages").value.trim();
    const avatarFile = document.getElementById("avatar").files[0];

    if (!messageInput) {
      alert("‚ùå you must enter a message before sending.");
      return;
    }

    const name = nameInput || "Anonymous";
    const lowerMessage = messageInput.toLowerCase();
    const containsBadWord = badWords.some(word => lowerMessage.includes(word));
    const userViolations = violations[name] || { count: 0, bannedUntil: null };
    const now = Date.now();

    if (userViolations.bannedUntil && now < userViolations.bannedUntil) {
      alert("‚ùå you are currently banned from sending messages. Please wait 5 minutes until the ban expires.");
      return;
    }

    if (containsBadWord) {
      userViolations.count += 1;

      if (userViolations.count === 1) {
        alert("‚ö†Ô∏è inappropriate language detected. This is your first warning.after 3 warnings, you will be banned for 5 minutes.");
      } else if (userViolations.count >= 3) {
        userViolations.bannedUntil = now + 5 * 60 * 1000;
        alert("üö´ you are banned from using massaging for 5 minutes because of using inappropriate words a lot");
        await client
          .from('messages')
          .insert([
            {
              name: "üö® system",
              message: `${name} is banned for using inappropriate language.`,
              avatar: "",
              timestamp: new Date().toISOString()

            }
          ]);
        violations[name] = userViolations;
        localStorage.setItem("violations", JSON.stringify(violations));
        return;
      }

      violations[name] = userViolations;
      localStorage.setItem("violations", JSON.stringify(violations));
    }

    let avatarUrl = "";

    if (avatarFile) {
      const avatarFileName = `avatar_${Date.now()}_${avatarFile.name}`.replace(/[^a-zA-Z0-9_.]/g, '_');

      const { data: uploadData, error: uploadError } = await client.storage
        .from('avatars')
        .upload(avatarFileName, avatarFile, {
          contentType: avatarFile.type
        });

      if (uploadError) {
        alert("‚ùå error uploading avatar.report this error: " + uploadError.message);
        return;
      }

      const { data: publicData } = client.storage
        .from('avatars')
        .getPublicUrl(avatarFileName);

      avatarUrl = publicData.publicUrl;
    }

    const { error: dbError } = await client
      .from('messages')
      .insert([
        {
          name: name,
          message: messageInput,
          avatar: avatarUrl,
          timestamp: new Date().toISOString()
        }
      ]);

    if (dbError) {
      alert("‚ùå error saving massege.report this problem " + dbError.message);
      return;
    }

    localStorage.setItem("chat_name", name);
    localStorage.setItem("chat_avatar", avatarUrl);

    const chat = document.getElementById("chat");
    const msgDiv = document.createElement("div");
    msgDiv.className = "message you";

    const nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.textContent = name + " ‚Ä¢ " + new Date().toLocaleTimeString();

    if (avatarUrl) {
      const avatarImg = document.createElement("img");
      avatarImg.src = avatarUrl;
      avatarImg.style.width = "50px";
      avatarImg.style.height = "50px";
      avatarImg.style.borderRadius = "100%";
      avatarImg.style.marginRight = "10px";
      nameDiv.prepend(avatarImg);
    }

    const messageDiv = document.createElement("div");
    messageDiv.textContent = messageInput;

    msgDiv.appendChild(nameDiv);
    msgDiv.appendChild(messageDiv);
    chat.appendChild(msgDiv);
    chat.scrollTop = chat.scrollHeight;

    document.getElementById("messages").value = "";
    document.getElementById("avatar").value = "";
  });
});
</script>
</body>
</html>